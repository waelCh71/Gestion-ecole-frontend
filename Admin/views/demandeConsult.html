<script>
  if (!localStorage.getItem("idA")) {
    window.location = "signIn.html";
  }
</script>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> NavBar </title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="../plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="../plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="../plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="../plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="../plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="../plugins/summernote/summernote-bs4.min.css">
</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">

    <!-- Preloader -->
    <div class="preloader flex-column justify-content-center align-items-center">
      <img class="animation__shake" src="../dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
    </div>

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="../index.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="mailBox.html" class="nav-link">Inbox</a>
        </li>
      </ul>
    </nav>
    <!-- /.navbar -->


    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <br>
      <!-- Brand Logo -->
      <a href="#" class="brand-link">
        <img src="../dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
          style="opacity: .8">
        <span class="brand-text font-weight-light">Admin</span>
      </a>
      <br>
      <!--TODO 1-->
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user panel (optional) -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img src="../dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">
          </div>
          <div class="info">
            <a href="profile.html" class="d-block" id="userName"></a>
          </div>
        </div>


        <!-- SidebarSearch Form -->
        <br>

        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
            <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->

            <li class="nav-item menu-open">
              <a href="../index.html" class="nav-link">
                <i class="nav-icon fas fa-tachometer-alt"></i>
                <p>
                  Dashboard
                </p>
              </a>

            </li>

            <br>

            <li class="nav-item">
              <a href="#" class="nav-link ">
                <i class="fas fa-user-graduate"></i>
                <p>
                  Students
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="addStudent.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>ADD</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="listStudent.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>List</p>
                  </a>
                </li>
              </ul>
            </li>
            <br>

            <li class="nav-item">
              <a href="#" class="nav-link ">
                <i class="fas fa-school"></i>
                <p>
                  Classes
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="addClasse.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>ADD</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="listClasse.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>List</p>
                  </a>
                </li>
              </ul>
            </li>
            <br>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="fas fa-calendar-alt"></i>
                <p>
                  Schedule
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="addSchedule.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>ADD</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="listSchedule.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>List</p>
                  </a>
                </li>
              </ul>
            </li>


            <br>
            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="fas fa-calendar-alt"></i>
                <p>
                  Events
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="addEvent.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>ADD</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="events.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Event</p>
                  </a>
                </li>
              </ul>
            </li>
            <br>

            <li class="nav-item">
              <a href="#" class="nav-link">
                <i class="fas fa-user-cog"></i>
                <p>
                  Users
                  <i class="fas fa-angle-left right"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="addUser.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>ADD</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="listUser.html" class="nav-link">
                    <i class="far fa-circle nav-icon"></i>
                    <p>List</p>
                  </a>
                </li>
              </ul>
            </li>

            <br>
            <li class="nav-item">
              <a href="demande.html" class="nav-link active">
                <i class="fas fa-file"></i>
                <p>
                  Paper Request
                </p>
              </a>
            </li>

            <br>
            <li class="nav-item">
              <a href="" onclick="logout();" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>
                <p>
                  Log Out

                </p>
              </a>

            </li>


          </ul>
        </nav>
        <!-- /.sidebar-menu -->
      </div>
      <!-- /.sidebar -->
    </aside>

    <!--TODO 2-->
    <!-- Main content -->


    <div class="content-wrapper" style="align-content: center; margin-left: 400px;">
      <div class="row">
        <div class="col-md-9">
          <div class="card word-document" id="container2">
            <img src="../dist/img/logo.png" height="60px" width="150px">
            <center>
              <h2 id="type"></h2>
            </center>
            <br>
            <p id="nom"></p>
            <p id="prenom"></p>
            <p id="numInscrit"></p>
            <p id="dob"></p>
            <p id="p">
            </p>
            <div class="signature" style="align-self: flex-end;">
              <p>Signature:</p>
              <!-- You can add a signature image or other signature-related content here -->
            </div>

          </div>
        </div>
        <div class="col-md-3 float-right"><button id="btnExport">Export as .doc</button></div>
      </div>
    </div>


    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->


  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #container2 {
      display: flex;
      justify-content: center;
      height: 100vh;
    }

    .card.word-document {
      background-color: #ffffff;
      padding: 20px;
      border: 1px solid #000000;
      width: 100%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      text-align: left;
    }

    h2#type {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    .signature {
      border-top: 1px solid #000000;
      padding-top: 10px;
      margin-top: 20px;
    }

    button#btnExport {
      background-color: #007bff;
      color: #ffffff;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      border-radius: 5px;
    }

    button#btnExport:hover {
      background-color: #0056b3;
    }
  </style>
  <!-- jQuery -->
  <script src="../plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="../plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- ChartJS -->
  <script src="../plugins/chart.js/Chart.min.js"></script>
  <!-- Sparkline -->
  <script src="../plugins/sparklines/sparkline.js"></script>
  <!-- JQVMap -->
  <script src="../plugins/jqvmap/jquery.vmap.min.js"></script>
  <script src="../plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
  <!-- jQuery Knob Chart -->
  <script src="../plugins/jquery-knob/jquery.knob.min.js"></script>
  <!-- daterangepicker -->
  <script src="../plugins/moment/moment.min.js"></script>
  <script src="../plugins/daterangepicker/daterangepicker.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Summernote -->
  <script src="../plugins/summernote/summernote-bs4.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="../plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../dist/js/adminlte.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="../dist/js/demo.js"></script>
  <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
  <script src="../dist/js/pages/dashboard.js"></script>

  <!--Convert To word-->
  <script>

    document.getElementById("btnExport").onclick = function () {
      //alert("work");
      exportHTML();
      changeStat();
    }

    function exportHTML() {
      var header = "<html> xmlns:o='urn:schemas-microsoft-com:office:office'" +
        "xmlns:w='urn:schemas-microsoft-com:office:word'" +
        "xmlns='http://www.w3.org/TR/REC-html40'" +
        "<head><meta charset='utf-8'><title>Export HTML to word Document with js</title></head><body>";

      var footer = "</body></html>";

      var sourceHTML = header + document.getElementById("container2").innerHTML + footer;

      var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);

      var fileDownload = document.createElement("a");

      document.body.appendChild(fileDownload);

      fileDownload.href = source;
      fileDownload.download = nomFichierDoc + '.doc';
      fileDownload.click();
      document.body.removeChild(fileDownload);


    }

  </script>

  <!--demande Info-->
  <script>

    var nomFichierDoc = "";

    var dataReady = "";

    const months = [
      "Janvier", "Février", "Mars", "Avril", "Mai", "Juin",
      "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"
    ];

    var listNotes = [];
    var url_string = window.location.href;
    var url = new URL(url_string);
    var c = url.searchParams.get("id");

    // Post a user
    var url3 = "http://127.0.0.1:3000/demandes/" + c;
    var xhr3 = new XMLHttpRequest();
    xhr3.open("GET", url3, true);

    xhr3.onload = function () {
      var response = JSON.parse(xhr3.responseText);
      dataReady = JSON.stringify(response);
      if (xhr3.readyState == 4 && xhr3.status == "200") {
        console.table(response);

        //Student Info Consult
        document.getElementById("type").innerHTML =
          response.type;


        var parentFullName = "";

        $.getJSON(
          "http://127.0.0.1:3000/users/" + response.idParent,
          function (parent) {

            parentFullName = parent.nom + " " + parent.prenom;
          }
        );

        $.getJSON(
          "http://127.0.0.1:3000/students/" + response.idStudent,
          function (student) {
            document.getElementById("nom").innerHTML = "Nom: " + student.nom;
            document.getElementById("prenom").innerHTML = "Prenom: " + student.prenom;

            document.getElementById("numInscrit").innerHTML = "N° Inscription: " + student.numInscription;
            document.getElementById("dob").innerHTML = "Date de Naissance: " + student.dateDeNaissance;

            nomFichierDoc = response.type + "_" + student.nom + " " + student.prenom;

            const dateActuelle = new Date();

            var date = dateActuelle.getDate() + " " + months[parseInt(dateActuelle.getMonth())] + " " + dateActuelle.getFullYear();

            if (response.type == "Attestation d'inscription") {
              document.getElementById("p").innerHTML = `Je soussigné <b>${localStorage.getItem("usernameA")}</b>, [votre titre ou fonction le cas échéant], atteste par la présente que<b> ${student.nom + ` ` + student.prenom} </b>est officiellement inscrit(e) à [Nom de l'institution] pour l'année [Année scolaire].
                            <br><br>Cette attestation est délivrée à la demande de `+ parentFullName + ` pour servir et valoir ce que de droit.
                            <br><br>Fait à [Lieu], le ${date}.`;
            }
            if (response.type == "Attestation de Presence") {
              document.getElementById("p").innerHTML = `Je soussigné <b>${localStorage.getItem("usernameA")}</b>, [votre titre ou fonction le cas échéant], atteste par la présente que <b>` + student.nom + ` ` + student.prenom + ` </b>était présent(e) à [Nom du lieu] pendant toute l'année scolaire [Année/Année].
                            <br><br>Cette attestation est délivrée à la demande de `+ parentFullName + ` pour servir et valoir ce que de droit.
                            <br><br>Fait à [Lieu], le ${date}.`;
            }
            if (response.type == "Attestation de réussite") {
              document.getElementById("p").innerHTML = `Je soussigné <b>${localStorage.getItem("usernameA")}</b>, [votre titre ou fonction le cas échéant], atteste par la présente que <b>` + student.nom + ` ` + student.prenom + ` </b>a réussi avec succès au cours de l'année scolaire [Année scolaire].
                            <br><br>Cette attestation est délivrée à la demande de `+ parentFullName + ` pour servir et valoir ce que de droit.
                            <br><br>Fait à [Lieu], le ${date}.`;
            } if (response.type == "Relevée de Note") {
              $.getJSON(
                "http://127.0.0.1:3000/notes/",
                function (data) {
                  data.forEach((i) => {
                    if (i.idStudent == response.idStudent) {
                      document.getElementById("container2").innerHTML =
                        `<div ><span class="float-left"><i onclick="moveGradesLeft()" class="fas fa-arrow-circle-left" style="font-size: 24px;"></i></span><div>
                            <div ><span class="float-right"><i class="fas fa-arrow-circle-right" style="font-size: 24px;"></i></span><div>
                            <br><br><embed id="notes" src="${i.mediaLink}" type="application/pdf" width="100%" height="600px" />`;
                      listNotes += i.mediaLink;
                    }
                  });
                });

            }

          }
        );

      } else {
        console.log("error");
      }
    };
    xhr3.send(null);
  </script>

  <!--TODO -->
  <script>
    function moveGradesLeft() {
      //alert(listNotes);
      var a = document.getElementById("notes").src;
      j = 0;
      listNotes.forEach((i) => {
        if (i == a) {
          document.getElementById("notes").src = listNotes[i + 1];
        }
        j += 1;
      });
    }
  </script>

  <script>
    function changeStat() {
      //alert(dataReady);
      info = JSON.parse(dataReady);

      var url3 = "http://127.0.0.1:3000/demandes/" + c;
      var data = {};

      data.idParent = info.idParent;
      data.idStudent = info.idStudent;
      data.dateDemende = info.dateDemende;
      data.type = info.type;
      data.etatActuelle = "Ready";
      data.remarque = info.remarque;

      var json = JSON.stringify(data); // Convertir la variable de données en JSON.
      var xhr = new XMLHttpRequest();
      xhr.open("PUT", url3, true);
      xhr.setRequestHeader("Content-type", "application/json; charset=utf-8");


      // Load les données à partir de la serveur -> début connection
      xhr.onload = function () {
        var response = JSON.parse(xhr.responseText); // Conversion des données en format json
        // Si le status retourné par le serveur est 200
        if (xhr.readyState == 4 && xhr.status == "200") {
          //location.replace("studentConsult.html?id="+c);
          console.log("done");
        } else {
          alert(response.message);
          //console.table(response);
        }
      };
      xhr.send(json);
    }
  </script>

  <script>
    document.getElementById("userName").innerHTML = localStorage.getItem("usernameA");
  </script>

  <!--LOgout-->
  <script>
    function logout() {
      var d = window.confirm("want to LogOut");
      if (d == true) {
        // localStorage.removeItem("idA");
        localStorage.clear();
        location.href = "signIn.html";
      }
    }
  </script>

  <!--Old Script : Convert to word with images-->
  <!--
    <script>

    document.getElementById("btnExport").onclick= function(){
        //alert("work");
        Export2Doc('container2','doc');
    }

    function Export2Doc(element, filename = '') {
            //  _html_ will be replace with custom html
            var meta= "Mime-Version: 1.0\nContent-Base: " + location.href + "\nContent-Type: Multipart/related; boundary=\"NEXT.ITEM-BOUNDARY\";type=\"text/html\"\n\n--NEXT.ITEM-BOUNDARY\nContent-Type: text/html; charset=\"utf-8\"\nContent-Location: " + location.href + "\n\n<!DOCTYPE html>\n<html>\n_html_</html>";
            //  _styles_ will be replaced with custome css
            var head= "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<style>\n_styles_\n</style>\n</head>\n";
  
            var html = document.getElementById(element).innerHTML ;
            
            var blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });
            
            var  css = (
                   '<style>' +
                   'img {width:300px;}table {border-collapse: collapse; border-spacing: 0;}td{padding: 6px;}' +
                   '</style>'
                  );
//  Image Area %%%%
            var options = { maxWidth: 624};
            var images = Array();
            var img = $("#"+element).find("img");
            for (var i = 0; i < img.length; i++) {
                // Calculate dimensions of output image
                var w = Math.min(img[i].width, options.maxWidth);
                var h = img[i].height * (w / img[i].width);
                // Create canvas for converting image to data URL
                var canvas = document.createElement("CANVAS");
                canvas.width = w;
                canvas.height = h;
                // Draw image to canvas
                var context = canvas.getContext('2d');
                context.drawImage(img[i], 0, 0, w, h);
                // Get data URL encoding of image
                var uri = canvas.toDataURL("image/png");
                $(img[i]).attr("src", img[i].src);
                img[i].width = w;
                img[i].height = h;
                // Save encoded image to array
                images[i] = {
                    type: uri.substring(uri.indexOf(":") + 1, uri.indexOf(";")),
                    encoding: uri.substring(uri.indexOf(";") + 1, uri.indexOf(",")),
                    location: $(img[i]).attr("src"),
                    data: uri.substring(uri.indexOf(",") + 1)
                };
            }

            // Prepare bottom of mhtml file with image data
            var imgMetaData = "\n";
            for (var i = 0; i < images.length; i++) {
                imgMetaData += "--NEXT.ITEM-BOUNDARY\n";
                imgMetaData += "Content-Location: " + images[i].location + "\n";
                imgMetaData += "Content-Type: " + images[i].type + "\n";
                imgMetaData += "Content-Transfer-Encoding: " + images[i].encoding + "\n\n";
                imgMetaData += images[i].data + "\n\n";
                
            }
            imgMetaData += "--NEXT.ITEM-BOUNDARY--";
// end Image Area %%

             var output = meta.replace("_html_", head.replace("_styles_", css) +  html) + imgMetaData;

            var url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(output);


            filename = filename ? filename + '.doc' : 'document.doc';


            var downloadLink = document.createElement("a");

            document.body.appendChild(downloadLink);

            if (navigator.msSaveOrOpenBlob) {
                navigator.msSaveOrOpenBlob(blob, filename);
            } else {

                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.click();
            }

            document.body.removeChild(downloadLink);
        }

  </script>
  -->
</body>

</html>